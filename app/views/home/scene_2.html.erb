<!DOCTYPE html>
<html lang="ja">
<%= stylesheet_link_tag 'scene_2', media: 'all', 'data-turbolinks-track': 'reload'%>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テキスト入力画面</title>
</head>

<body>
    <div class="canvas-wrapper">
        <div class = "background">
            <canvas id="BackgroundCanvas" width="1280px" height="580px" style="background-color: #D9D9D9;"></canvas>
        </div>

        <div class = "gameBackground">
            <canvas id="GameBackgroundCanvas" width="1280px" height="580px"></canvas>
        </div>

        <div class="message-window">
            <canvas id="MessageWindowCanvas" width="1280px" height="580px"></canvas>
            <div class="message-box">メッセージウィンドウ</div>
        </div>

        <div class="input-window">
            <canvas id="InputWindowCanvas" width="858px" height="140px"></canvas>
            <form class="input_form">
                <textarea id="message-input" placeholder='返答を記入してください' required></textarea>
               </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            var background_canvas = document.getElementById('BackgroundCanvas');
            var game_background_canvas = document.getElementById('GameBackgroundCanvas');
            var message_window_canvas = document.getElementById('MessageWindowCanvas');
            var input_window_canvas = document.getElementById('InputWindowCanvas');

            if (background_canvas) {
                var background_ctx = background_canvas.getContext('2d');

                // // Canvasのサイズを設定
                // background_canvas.width = background_canvas.offsetWidth;
                // background_canvas.height = background_canvas.offsetHeight;

                // 塗りつぶす
                background_ctx.fillStyle = "Orange";        // 塗りつぶす色
                // rgb(217,217,217)
                background_ctx.fillRect(0, 0, background_canvas, background_canvas);    // 描画
            }

            if (game_background_canvas) {
                var game_background_ctx = game_background_canvas.getContext('2d');

                // Canvasのサイズを設定
                game_background_canvas.width = game_background_canvas.offsetWidth;
                game_background_canvas.height = game_background_canvas.offsetHeight;

                // 背景画像を描画
                var game_background_img = new Image();
                game_background_img.src = '<%= asset_path("/scean_1.png") %>';  // 背景画像のパスを指定
                game_background_img.onload = function() {
                    game_background_ctx.drawImage(game_background_img, 189, 36, 901, 507);
                }
            }

            if (message_window_canvas) {
                var message_window_ctx = message_window_canvas.getContext('2d');
                message_window_canvas.width = message_window_canvas.offsetWidth;
                message_window_canvas.height = message_window_canvas.offsetHeight;
                var message_window_img = new Image();
                message_window_img.src = '<%= asset_path("/messagewindow.png") %>';
                message_window_img.onload = function() {
                    message_window_ctx.drawImage(message_window_img, 279, 365, 758, 178);
                    /*テスト用のメッセージを描画*/
                    var names = ["李 光","高山 圭","山本 大輔", "佐藤　美咲子", "田中　陽子美"];
                    var messages = ["李光は静かで知識豊富な青年で、常に冷静な判断を下すことができます。彼の趣味は読書と天文学で、特に星空を観察するのが好きです。社交的ではないが、親しい友人とは深い絆を持ち、信頼される存在です。",
                                    "高山圭は明るく社交的な女性で、誰とでもすぐに打ち解けることができます。趣味はダンスと映画鑑賞で、新しいものに挑戦することが好きです。彼女の元気な性格は周囲の人々にポジティブな影響を与えます。",
                                    "山本大輔は穏やかで優しい青年で、どんな状況でも冷静さを保ちます。趣味はガーデニングと写真撮影で、自然を愛し、その美しさをカメラに収めるのが好きです。人との対話が得意で、周囲から信頼されています。",
                                    "佐藤美咲子は活発で元気な女性で、周囲を明るくする存在です。趣味はスポーツと音楽鑑賞で、特にチームスポーツを楽しんでいます。リーダーシップがあり、どんな困難にも前向きに取り組む姿勢が評価されています。",
                                    "田中陽子美は真面目で誠実な女性で、常に周囲の人々を気遣います。趣味は料理と読書で、新しいレシピを試すのが好きです。彼女の優しさと思いやりのある性格は、多くの人々から尊敬されています。"];
                    message_window_ctx.font = "35px SeoulNamsan";
                    message_window_ctx.fillStyle = "black";
                    var textHeight = 20;
                    var lineHeight = textHeight + 10;
                    var randNum = Math.floor(Math.random() * names.length);/*ランダムで名前を表示*/
                    message_window_ctx.fillText(names[randNum], 279 + 20, 365 + 38);

                    message_window_ctx.font = "20px SeoulNamsan";
                    var maxWidth = 758 - 40; // メッセージウィンドウの幅から左右のマージンを引いた値
                    var randNum = Math.floor(Math.random() * messages.length); /*ランダムでメッセージを表示*/
                    var wrappedText = wrapText(message_window_ctx, messages[randNum], maxWidth);
                    
                    // テキストを一文字ずつ描画
                    var charIndex = 0;
                    var lineIndex = 0;
                    var x = 279 + 20;
                    var y = 365 + 80;

                    function drawNextChar() {
                        if (lineIndex < wrappedText.length) {
                            if (charIndex < wrappedText[lineIndex].length) {
                                message_window_ctx.fillText(wrappedText[lineIndex][charIndex], x, y);
                                charIndex++;
                                x += message_window_ctx.measureText(wrappedText[lineIndex][charIndex - 1]).width;
                                setTimeout(drawNextChar, 30); // 30ミリ秒ごとに次の文字を描画
                            } else {
                                charIndex = 0;
                                lineIndex++;
                                x = 279 + 20;
                                y += lineHeight;
                                setTimeout(drawNextChar, 30);
                            }
                        }
                    }

                    drawNextChar();
                }

                function wrapText(context, text, maxWidth) {
                    var lines = [];
                    var currentLine = '';
                    for (var i = 0; i < text.length; i++) {
                        var char = text[i];
                        var testLine = currentLine + char;
                        var width = context.measureText(testLine).width;
                        if (width > maxWidth && currentLine !== '') {
                            lines.push(currentLine);
                            currentLine = char;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    lines.push(currentLine);
                    return lines;
                }
            }

            if (input_window_canvas) {
                var input_window_ctx = input_window_canvas.getContext('2d');

                // input_window_canvasのサイズを設定
                input_window_canvas.width = input_window_canvas.offsetWidth;
                input_window_canvas.height = input_window_canvas.offsetHeight;
                
                document.getElementById('message-input').addEventListener('input', function() {
                    document.querySelector('.message-box').innerText = this.value || 'メッセージウィンドウ';
                });
            }

        });

    </script>
</body>

</html>
